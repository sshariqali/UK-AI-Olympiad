define("discourse/plugins/discourse-local-dates/discourse/components/modal/local-dates-create",["exports","@ember/component","@ember/helper","@ember/modifier","@ember/object","@ember/object/computed","@ember/runloop","@ember/template","@ember-decorators/component","@ember-decorators/object","discourse/components/calendar-date-time-input","discourse/components/d-button","discourse/components/d-modal","discourse/components/text-field","discourse/helpers/d-icon","discourse/lib/computed","discourse/lib/decorators","discourse/lib/environment","discourse/lib/local-dates","discourse/lib/text","discourse/select-kit/components/combo-box","discourse/select-kit/components/multi-select","discourse/select-kit/components/timezone-input","discourse-i18n","discourse/plugins/discourse-local-dates/lib/local-date-markup-generator","@ember/template-factory"],function(e,t,a,o,i,n,s,r,d,l,c,m,u,f,p,h,z,g,_,T,y,b,w,v,D,L){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
const F=dt7948.c(class extends t.default{timeFormat="HH:mm:ss"
dateFormat="YYYY-MM-DD"
dateTimeFormat="YYYY-MM-DD HH:mm:ss"
date=null
toDate=null
time=null
toTime=null
format=null
formats=null
recurring=null
advancedMode=!1
timezone=null
fromSelected=null
toSelected=null
static{dt7948.g(this.prototype,"fromFilled",[(0,n.notEmpty)("date")])}#e=void dt7948.i(this,"fromFilled")
static{dt7948.g(this.prototype,"toFilled",[(0,n.notEmpty)("toDate")])}#t=void dt7948.i(this,"toFilled")
static{dt7948.g(this.prototype,"timezoneIsDifferentFromUserTimezone",[(0,h.propertyNotEqual)("currentUserTimezone","options.timezone")])}#a=void dt7948.i(this,"timezoneIsDifferentFromUserTimezone")
init(){super.init(...arguments),this._picker=null,this.setProperties({timezones:[],formats:(this.siteSettings.discourse_local_dates_default_formats||"").split("|").filter(e=>e),timezone:this.currentUserTimezone,date:moment().format(this.dateFormat)})}didInsertElement(){super.didInsertElement(...arguments),this.send("focusFrom")}configChanged(){this._renderPreview()}static{dt7948.n(this.prototype,"configChanged",[(0,l.observes)("computedConfig.{from,to,options}","options","isValid","isRange")])}async _renderPreview(){if(this.markup){const e=await(0,T.cook)(this.markup)
this.set("currentPreview",e),(0,s.schedule)("afterRender",()=>{(0,_.applyLocalDates)(document.querySelectorAll(".preview .discourse-local-date"),this.siteSettings)})}}static{dt7948.n(this.prototype,"_renderPreview",[(0,z.debounce)(g.INPUT_DELAY)])}isRange(e,t,a){return e&&(t||a)}static{dt7948.n(this.prototype,"isRange",[(0,z.default)("date","toDate","toTime")])}isValid(e,t){const a=e.from
if(!e.from.dateTime||!e.from.dateTime.isValid())return!1
if(t){const t=e.to
if(!t.dateTime||!t.dateTime.isValid()||t.dateTime.diff(a.dateTime)<0)return!1}return!0}static{dt7948.n(this.prototype,"isValid",[(0,z.default)("computedConfig","isRange")])}fromConfig(e,t,a,o={}){const n=!t
let s
s=n?moment.tz(e,o.timezone):moment.tz(`${e} ${t}`,o.timezone),n||(t=s.format(this.timeFormat))
let r=o.format
return!n||"LLL"!==r&&"LLLL"!==r||(r="LL"),i.default.create({date:s.format(this.dateFormat),time:t,dateTime:s,format:r,range:!!a&&"start"})}static{dt7948.n(this.prototype,"fromConfig",[(0,z.default)("date","time","isRange","options.{format,timezone}")])}toConfig(e,t,a,o={}){const n=!t
let s
t&&!e&&(e=moment().format(this.dateFormat)),s=n?moment.tz(e,o.timezone).endOf("day"):moment.tz(`${e} ${t}`,o.timezone),n||(t=s.format(this.timeFormat))
let r=o.format
return!n||"LLL"!==r&&"LLLL"!==r||(r="LL"),i.default.create({date:s.format(this.dateFormat),time:t,dateTime:s,format:r,range:!!a&&"end"})}static{dt7948.n(this.prototype,"toConfig",[(0,z.default)("toDate","toTime","isRange","options.{timezone,format}")])}options(e,t,a,o){return i.default.create({recurring:e,timezones:t,timezone:a,format:o})}static{dt7948.n(this.prototype,"options",[(0,z.default)("recurring","timezones","timezone","format")])}computedConfig(e,t,a){return i.default.create({from:e,to:t,options:a})}static{dt7948.n(this.prototype,"computedConfig",[(0,z.default)("fromConfig.{date}","toConfig.{date}","options.{recurring,timezones,timezone,format}")])}currentUserTimezone(){return this.currentUser.user_option.timezone||moment.tz.guess()}static{dt7948.n(this.prototype,"currentUserTimezone",[z.default])}allTimezones(){return moment.tz.names()}static{dt7948.n(this.prototype,"allTimezones",[z.default])}formattedCurrentUserTimezone(e){return e.replace("_"," ").replace("Etc/","").replace("/",", ")}static{dt7948.n(this.prototype,"formattedCurrentUserTimezone",[(0,z.default)("currentUserTimezone")])}previewedFormats(e){return e.map(e=>({format:e,preview:moment().format(e)}))}static{dt7948.n(this.prototype,"previewedFormats",[(0,z.default)("formats")])}recurringOptions(){const e="discourse_local_dates.create.form.recurring"
return[{name:(0,v.i18n)(`${e}.every_day`),id:"1.days"},{name:(0,v.i18n)(`${e}.every_week`),id:"1.weeks"},{name:(0,v.i18n)(`${e}.every_two_weeks`),id:"2.weeks"},{name:(0,v.i18n)(`${e}.every_month`),id:"1.months"},{name:(0,v.i18n)(`${e}.every_two_months`),id:"2.months"},{name:(0,v.i18n)(`${e}.every_three_months`),id:"3.months"},{name:(0,v.i18n)(`${e}.every_six_months`),id:"6.months"},{name:(0,v.i18n)(`${e}.every_year`),id:"1.years"}]}static{dt7948.n(this.prototype,"recurringOptions",[z.default])}_generateDateMarkup(e,t,a,o){return(0,D.default)(e,t,a,o)}toggleModeBtnLabel(e){return e?"discourse_local_dates.create.form.simple_mode":"discourse_local_dates.create.form.advanced_mode"}static{dt7948.n(this.prototype,"toggleModeBtnLabel",[(0,z.default)("advancedMode")])}markup(e,t,a,o){let i
return a&&e.from&&(i=e.to&&e.to.range?this._generateDateMarkup(e.from,t,o,e.to):this._generateDateMarkup(e.from,t,o)),i}static{dt7948.n(this.prototype,"markup",[(0,z.default)("computedConfig.{from,to,options}","options","isValid","isRange")])}formattedFrom(e){return e.format("LLLL")}static{dt7948.n(this.prototype,"formattedFrom",[(0,z.default)("fromConfig.dateTime")])}formattedTo(e){return e.isValid()?e.format("LLLL"):(0,v.i18n)("discourse_local_dates.create.form.until")}static{dt7948.n(this.prototype,"formattedTo",[(0,z.default)("toConfig.dateTime")])}updateFormat(e,t){t?.preventDefault(),this.set("format",e)}static{dt7948.n(this.prototype,"updateFormat",[i.action])}selectedDate(e){return e?this.date:this.toDate}static{dt7948.n(this.prototype,"selectedDate",[(0,z.default)("fromSelected","toSelected")])}selectedTime(e){return e?this.time:this.toTime}static{dt7948.n(this.prototype,"selectedTime",[(0,z.default)("fromSelected","toSelected")])}changeSelectedDate(e){this.fromSelected?this.set("date",e):this.set("toDate",e)}static{dt7948.n(this.prototype,"changeSelectedDate",[i.action])}changeSelectedTime(e){this.fromSelected?this.set("time",e):this.set("toTime",e)}static{dt7948.n(this.prototype,"changeSelectedTime",[i.action])}eraseToDateTime(){this.setProperties({toDate:null,toTime:null}),this.focusFrom()}static{dt7948.n(this.prototype,"eraseToDateTime",[i.action])}focusFrom(){this.setProperties({fromSelected:!0,toSelected:!1,minDate:null})}static{dt7948.n(this.prototype,"focusFrom",[i.action])}focusTo(){this.setProperties({toSelected:!0,fromSelected:!1,minDate:this.get("fromConfig.date")})}static{dt7948.n(this.prototype,"focusTo",[i.action])}toggleAdvancedMode(){this.toggleProperty("advancedMode")}static{dt7948.n(this.prototype,"toggleAdvancedMode",[i.action])}save(){const e=this.markup
e&&(this.closeModal(),this.model.insertDate(e))}static{dt7948.n(this.prototype,"save",[i.action])}cancel(){this.closeModal()}static{dt7948.n(this.prototype,"cancel",[i.action])}static{(0,t.setComponentTemplate)((0,L.createTemplateFactory)({id:"mVy4nBHW",block:'[[[8,[32,0],[[24,0,"discourse-local-dates-create-modal -large"]],[["@title","@closeModal"],[[28,[32,1],["discourse_local_dates.title"],null],[30,1]]],[["body","footer"],[[[[1,"\\n    "],[10,0],[14,0,"form"],[12],[1,"\\n"],[41,[30,0,["isValid"]],[[[41,[30,0,["timezoneIsDifferentFromUserTimezone"]],[[[1,"          "],[10,0],[14,0,"preview alert alert-info"],[12],[1,"\\n            "],[1,[28,[32,1],["discourse_local_dates.create.form.current_timezone"],null]],[1,"\\n            "],[10,"b"],[12],[1,[30,0,["formattedCurrentUserTimezone"]]],[13],[1,[30,0,["currentPreview"]]],[1,"\\n          "],[13],[1,"\\n"]],[]],null]],[]],[[[1,"        "],[10,0],[14,0,"validation-error alert alert-error"],[12],[1,"\\n          "],[1,[28,[32,1],["discourse_local_dates.create.form.invalid_date"],null]],[1,"\\n        "],[13],[1,"\\n"]],[]]],[1,"\\n      "],[1,[30,0,["computeDate"]]],[1,"\\n\\n      "],[10,0],[14,0,"date-time-configuration"],[12],[1,"\\n        "],[10,0],[14,0,"inputs-panel"],[12],[1,"\\n          "],[10,0],[15,0,[29,["date-time-control from\\n              ",[52,[30,0,["fromSelected"]],"is-selected"],"\\n              ",[52,[30,0,["fromFilled"]],"is-filled"]]]],[12],[1,"\\n            "],[1,[28,[32,2],["calendar-days"],null]],[1,"\\n            "],[8,[32,3],[[24,1,"from-date-time"],[24,0,"date-time"],[24,"autofocus",""]],[["@action","@translatedLabel"],[[30,0,["focusFrom"]],[30,0,["formattedFrom"]]]],null],[1,"\\n          "],[13],[1,"\\n\\n          "],[10,0],[15,0,[29,["date-time-control to\\n              ",[52,[30,0,["toSelected"]],"is-selected"],"\\n              ",[52,[30,0,["toFilled"]],"is-filled"]]]],[12],[1,"\\n            "],[1,[28,[32,2],["calendar-days"],null]],[1,"\\n            "],[8,[32,3],[[24,0,"date-time"]],[["@action","@translatedLabel"],[[30,0,["focusTo"]],[30,0,["formattedTo"]]]],null],[1,"\\n"],[41,[30,0,["toFilled"]],[[[1,"              "],[8,[32,3],[[24,0,"delete-to-date"]],[["@action","@icon"],[[30,0,["eraseToDateTime"]],"xmark"]],null],[1,"\\n"]],[]],null],[1,"          "],[13],[1,"\\n\\n"],[41,[30,0,["site","desktopView"]],[[[1,"            "],[8,[32,4],null,[["@options","@value","@onChange"],[[28,[32,5],null,[["icon"],["globe"]]],[30,0,["timezone"]],[28,[32,6],[[28,[31,1],[[30,0,["timezone"]]],null]],null]]],null],[1,"\\n"]],[]],null],[1,"        "],[13],[1,"\\n\\n        "],[10,0],[14,0,"picker-panel"],[12],[1,"\\n          "],[8,[32,7],null,[["@datePickerId","@date","@time","@minDate","@timeFormat","@dateFormat","@onChangeDate","@onChangeTime"],["local-date-create-form",[30,0,["selectedDate"]],[30,0,["selectedTime"]],[30,0,["minDate"]],[30,0,["timeFormat"]],[30,0,["dateFormat"]],[30,0,["changeSelectedDate"]],[30,0,["changeSelectedTime"]]]],null],[1,"\\n        "],[13],[1,"\\n\\n"],[41,[30,0,["site","mobileView"]],[[[1,"          "],[8,[32,4],null,[["@value","@options","@onChange"],[[30,0,["timezone"]],[28,[32,5],null,[["icon"],["globe"]]],[28,[32,6],[[28,[31,1],[[30,0,["timezone"]]],null]],null]]],null],[1,"\\n"]],[]],null],[1,"      "],[13],[1,"\\n\\n"],[41,[30,0,["advancedMode"]],[[[1,"        "],[10,0],[14,0,"advanced-options"],[12],[1,"\\n"],[41,[51,[30,0,["isRange"]]],[[[1,"            "],[10,0],[14,0,"control-group recurrence"],[12],[1,"\\n              "],[10,"label"],[14,0,"control-label"],[12],[1,"\\n                "],[1,[28,[32,1],["discourse_local_dates.create.form.recurring_title"],null]],[1,"\\n              "],[13],[1,"\\n              "],[10,2],[12],[1,[28,[32,8],[[28,[32,1],["discourse_local_dates.create.form.recurring_description"],null]],null]],[13],[1,"\\n              "],[10,0],[14,0,"controls"],[12],[1,"\\n                "],[8,[32,9],[[24,0,"recurrence-input"]],[["@content","@value","@onChange","@options"],[[30,0,["recurringOptions"]],[30,0,["recurring"]],[28,[32,6],[[28,[31,1],[[30,0,["recurring"]]],null]],null],[28,[32,5],null,[["none"],["discourse_local_dates.create.form.recurring_none"]]]]],null],[1,"\\n              "],[13],[1,"\\n            "],[13],[1,"\\n"]],[]],null],[1,"\\n          "],[10,0],[14,0,"control-group timezones"],[12],[1,"\\n            "],[10,"label"],[12],[1,[28,[32,1],["discourse_local_dates.create.form.timezones_title"],null]],[13],[1,"\\n            "],[10,2],[12],[1,[28,[32,1],["discourse_local_dates.create.form.timezones_description"],null]],[13],[1,"\\n            "],[10,0],[14,0,"controls"],[12],[1,"\\n              "],[8,[32,10],[[24,0,"timezones-input"]],[["@valueProperty","@nameProperty","@content","@value","@options"],[null,null,[30,0,["allTimezones"]],[30,0,["timezones"]],[28,[32,5],null,[["allowAny","maximum"],[false,5]]]]],null],[1,"\\n            "],[13],[1,"\\n          "],[13],[1,"\\n\\n          "],[10,0],[14,0,"control-group format"],[12],[1,"\\n            "],[10,"label"],[12],[1,[28,[32,1],["discourse_local_dates.create.form.format_title"],null]],[13],[1,"\\n            "],[10,2],[12],[1,"\\n              "],[1,[28,[32,1],["discourse_local_dates.create.form.format_description"],null]],[1,"\\n              "],[10,3],[14,"target","_blank"],[14,6,"https://momentjs.com/docs/#/parsing/string-format/"],[14,"rel","noopener noreferrer"],[12],[1,"\\n                "],[1,[28,[32,2],["circle-question"],null]],[1,"\\n              "],[13],[1,"\\n            "],[13],[1,"\\n            "],[10,0],[14,0,"controls"],[12],[1,"\\n              "],[8,[32,11],[[24,0,"format-input"]],[["@value"],[[30,0,["format"]]]],null],[1,"\\n            "],[13],[1,"\\n          "],[13],[1,"\\n          "],[10,0],[14,0,"control-group"],[12],[1,"\\n            "],[10,"ul"],[14,0,"formats"],[12],[1,"\\n"],[42,[28,[31,4],[[28,[31,4],[[30,0,["previewedFormats"]]],null]],null],null,[[[1,"                "],[10,"li"],[14,0,"format"],[12],[1,"\\n                  "],[11,3],[24,0,"moment-format"],[24,6,""],[4,[32,12],["click",[28,[32,6],[[30,0,["updateFormat"]],[30,2,["format"]]],null]],null],[12],[1,"\\n                    "],[1,[30,2,["format"]]],[1,"\\n                  "],[13],[1,"\\n                  "],[10,1],[14,0,"previewed-format"],[12],[1,"\\n                    "],[1,[30,2,["preview"]]],[1,"\\n                  "],[13],[1,"\\n                "],[13],[1,"\\n"]],[2]],null],[1,"            "],[13],[1,"\\n          "],[13],[1,"\\n        "],[13],[1,"\\n"]],[]],null],[1,"    "],[13],[1,"\\n  "]],[]],[[[1,"\\n\\n"],[41,[30,0,["isValid"]],[[[1,"      "],[8,[32,3],[[24,0,"btn-primary"]],[["@action","@label"],[[30,0,["save"]],"discourse_local_dates.create.form.insert"]],null],[1,"\\n"]],[]],null],[1,"\\n    "],[8,[32,3],[[24,0,"btn-flat"]],[["@action","@translatedLabel"],[[30,0,["cancel"]],[28,[32,1],["cancel"],null]]],null],[1,"\\n\\n    "],[8,[32,3],[[24,0,"btn-default advanced-mode-btn"]],[["@action","@icon","@label"],[[30,0,["toggleAdvancedMode"]],"gear",[30,0,["toggleModeBtnLabel"]]]],null],[1,"\\n  "]],[]]]]]],["@closeModal","previewedFormat"],["if","mut","unless","each","-track-array"]]',moduleName:"/var/www/discourse/frontend/discourse/discourse/plugins/discourse-local-dates/discourse/components/modal/local-dates-create.js",scope:()=>[u.default,v.i18n,p.default,m.default,w.default,a.hash,a.fn,c.default,r.htmlSafe,y.default,b.default,f.default,o.on],isStrictMode:!0}),this)}},[(0,d.tagName)("")])
e.default=F}),define("discourse/plugins/discourse-local-dates/discourse/initializers/local-dates-admin-plugin-configuration-nav",["exports","discourse/lib/plugin-api"],function(e,t){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
e.default={name:"local-dates-admin-plugin-configuration-nav",initialize(e){const a=e.lookup("service:current-user")
a?.admin&&(0,t.withPluginApi)(e=>{e.setAdminPluginIcon("discourse-local-dates","far-clock")})}}}),define("discourse/plugins/discourse-local-dates/initializers/discourse-local-dates",["exports","@ember/owner","@ember/service","@ember/template","discourse/lib/bbcode-attributes","discourse/lib/decorators","discourse/lib/download-calendar","discourse/lib/icon-library","discourse/lib/plugin-api","discourse/lib/to-markdown","discourse/lib/utilities","discourse-i18n","discourse/plugins/discourse-local-dates/lib/local-date-markup-generator","discourse/plugins/discourse-local-dates/discourse/components/modal/local-dates-create","discourse/plugins/discourse-local-dates/lib/generate-current-date-markup","discourse/plugins/discourse-local-dates/lib/local-date-builder","discourse/plugins/discourse-local-dates/lib/rich-editor-extension"],function(e,t,a,o,i,n,s,r,d,l,c,m,u,f,p,h,z){"use strict"
function g(e,t,a){if(!t.discourse_local_dates_enabled)return
const o=a||moment.tz.guess()
e.forEach((e,a,i)=>{const n=T(e,t)
if("to"===e.attributes["data-range"]?.value&&0!==a&&"from"===i[a-1].attributes["data-range"]?.value){(function(e,t){if(!e.attributes["data-time"]||!t.attributes["data-time"])return!1
const a=e.attributes["data-timezone"].value,o=moment(_(e)).tz(a),i=moment(_(t)).tz(a)
return o.isSame(i,"day")})(i[a-1],e)&&(n.sameLocalDayAsFrom=!0)}const s=new h.default(n,o).build()
e.innerText="",e.insertAdjacentHTML("beforeend",`${(0,r.iconHTML)("earth-americas")}\n        <span class="relative-time">${s.formatted}</span>`),e.setAttribute("aria-label",s.textPreview)
const d=["cooked-date"]
s.pastEvent&&d.push("past"),e.classList.add(...d)})}function _(e){return`${e.attributes["data-date"].value}T${e.attributes["data-time"].value}`}function T(e,t){const a={},o=e.dataset
return 2===b(e).length&&(a.duration=function(e){const[t,a]=b(e).map(e=>e.dataset),o=moment(`${t.date} ${t.time||""}`.trim()),i=moment(`${a.date} ${a.time||""}`.trim()).diff(o,"minutes")
return e.dataset===t?i:-i}(e)),a.time=o.time,a.date=o.date,a.recurring=o.recurring,a.timezones=(o.timezones||t.discourse_local_dates_default_timezones||"Etc/UTC").split("|").filter(Boolean),a.timezone=o.timezone,a.displayedTimezone=o.displayedTimezone,a.format=o.format||(a.time?"LLL":"LL"),a.countdown=o.countdown,a.calendar=o.calendar?"on"===o.calendar:!o.format,a}function y(e){const t={}
return t.time=e.attributes["data-time"],t.date=e.attributes["data-date"],t.recurring=e.attributes["data-recurring"],t.timezones=e.attributes["data-timezones"],t.timezone=e.attributes["data-timezone"],t.calendar="on"===(e.attributes["data-calendar"]||"on"),t.displayedTimezone=e.attributes["data-displayed-timezone"],t.format=e.attributes["data-format"],t.countdown=e.attributes["data-countdown"],t.range=e.attributes["data-range"],t}function b(e){return e.parentElement?e.dataset.range?function(e){const t=[],a=Array.from(e.parentElement.children).filter(e=>e.dataset.range)
for(;a.length>0;)t.push(a.splice(0,2))
return t}(e).find(t=>t.includes(e)):[e]:[]}function w(e){e.registerRichEditorExtension(z.default)
const t=e.container.lookup("service:modal"),a=e.container.lookup("service:site-settings"),o=(0,m.i18n)("discourse_local_dates.default_title",{site_name:a.title})
e.decorateCookedElement((e,t)=>{const i=e.querySelectorAll(".discourse-local-date")
g(i,a)
const n=t?.getModel()?.topic?.title
i.forEach(e=>{e.dataset.title=e.dataset.title||n||o})}),e.addComposerToolbarPopupMenuOption({name:"local-dates",label:"discourse_local_dates.title",icon:"far-clock",action:e=>t.show(f.default,{model:{insertDate:t=>e.addText(t)}}),shortcut:"Shift+.",alwaysShowShortcut:!0,shortcutAction:t=>{const a=e.getCurrentUser().user_option.timezone
t.addText((0,p.default)(a))}}),(0,l.addTextDecorateCallback)(function(e,t,a,o){if(o.discourseLocalDateStartRangeOpts&&t?.attributes.class?.includes("discourse-local-date")&&"→"===e)return""}),(0,l.addTagDecorateCallback)(function(){if(this.element.attributes.class?.includes("discourse-local-date")){if(this.metadata.discourseLocalDateStartRangeOpts){const e=this.metadata.discourseLocalDateStartRangeOpts,t=y(this.element),a=(0,u.default)({date:e.date,time:e.time,format:e.format},t,!0,{date:t.date,time:t.time,format:t.format})
return this.prefix=a,this.metadata.discourseLocalDateStartRangeOpts=null,""}if("true"===this.element.attributes["data-range"]||"from"===this.element.attributes["data-range"]||"to"===this.element.attributes["data-range"])return this.metadata.discourseLocalDateStartRangeOpts=y(this.element),""
const e=y(this.element),t=(0,u.default)({date:e.date,time:e.time,format:e.format},e,!1)
return this.prefix=t,""}})}function v(e,t){const a=T(e,t),o=new h.default(a,moment.tz.guess()).build().previews.map(e=>{const t=document.createElement("div")
t.classList.add("preview"),e.current&&t.classList.add("current")
const a=document.createElement("span")
a.classList.add("timezone"),a.innerText=e.timezone,t.appendChild(a)
const o=document.createElement("span")
return o.classList.add("date-time"),o.innerHTML=e.formatted,t.appendChild(o),t}),i=document.createElement("div")
i.classList.add("locale-dates-previews"),o.forEach(e=>i.appendChild(e))
const n=function(e){const[t,a]=b(e).map(e=>e.dataset),[o,i]=function(e,t){let a,o
a=moment.tz(`${e.date} ${e.time||""}`.trim(),e.timezone),t&&(o=moment.tz(`${t.date} ${t.time||""}`.trim(),t.timezone))
return[a,o]}(t,a)
if(o<moment().tz(t.timezone))return!1
const n=document.createElement("div")
n.classList.add("download-calendar"),n.innerHTML=`${(0,r.renderIcon)("string","file")} ${(0,m.i18n)("download_calendar.add_to_calendar")}`,n.setAttribute("data-starts-at",o.toISOString()),a&&n.setAttribute("data-ends-at",i.toISOString())
t.time||a||n.setAttribute("data-ends-at",o.add(24,"hours").toISOString())
t.title&&n.setAttribute("data-title",t.title)
t.timezone&&n.setAttribute("data-timezone",t.timezone)
t.ics&&n.setAttribute("data-ics",t.ics)
return n}(e)
return n&&i.appendChild(n),i.outerHTML}Object.defineProperty(e,"__esModule",{value:!0}),e.applyLocalDates=g,e.default=void 0
class D{static{dt7948.g(this.prototype,"siteSettings",[a.service])}#o=void dt7948.i(this,"siteSettings")
static{dt7948.g(this.prototype,"tooltip",[a.service])}#i=void dt7948.i(this,"tooltip")
constructor(e){(0,t.setOwner)(this,e),window.addEventListener("click",this.showDatePopover,{passive:!0}),this.siteSettings.discourse_local_dates_enabled&&(0,d.withPluginApi)(w)}showDatePopover(e){if(e?.target?.classList?.contains("download-calendar")){const t=e.target.dataset
if(t.ics){const e=(0,i.bbcodeAttributeDecode)(t.ics)
let a
if(t.title)a=t.title
else{const t=e.match(/SUMMARY:(.+?)[\r\n]/)
t&&t[1]&&(a=t[1].trim())}this.downloadIcs(a||"event",e)}else{const e=[{startsAt:t.startsAt,endsAt:t.endsAt}]
t.timezone&&(e[0].timezone=t.timezone),(0,s.downloadCalendar)(t.title,e)}return this.tooltip.close("local-date")}if(e?.target?.classList?.contains("discourse-local-date"))return this.tooltip.show(e.target,{identifier:"local-date",content:(0,o.htmlSafe)(v(e.target,this.siteSettings))})}static{dt7948.n(this.prototype,"showDatePopover",[n.bind])}downloadIcs(e,t){const a=new Blob([t],{type:"text/calendar;charset=utf-8"}),o=URL.createObjectURL(a)
try{const t=document.createElement("a")
t.href=o
const a=(0,c.slugify)(e)
t.download=`${a}.ics`,t.click()}finally{setTimeout(()=>URL.revokeObjectURL(o),0)}}teardown(){window.removeEventListener("click",this.showDatePopover)}}e.default={initialize(e){this.instance=new D(e)},teardown(){this.instance.teardown(),this.instance=null}}}),define("discourse/plugins/discourse-local-dates/lib/date-with-zone-helper",["exports","@ember/object"],function(e,t){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
class a{static fromDatetime(e,t,o){return new a({year:e.year(),month:e.month(),day:e.date(),hour:e.hour(),minute:e.minute(),second:e.second(),timezone:t,localTimezone:o})}constructor(e={}){this.timezone=e.timezone||"UTC",this.localTimezone=e.localTimezone||moment.tz.guess(),this.datetime=moment.tz((0,t.getProperties)(e,["year","month","day","hour","minute","second"]),this.timezone)}isDST(){return this.datetime.tz(this.localTimezone).isDST()}unitRepetitionsBetweenDates(e,t){const[a,o]=e.split("."),i=Math.abs(this.datetime.diff(t,o,!0)),n=i/a%1
return Math.trunc(i/a)*parseInt(a,10)+(n>0?parseInt(a,10):0)}add(e,t){return this._fromDatetime(this.datetime.clone().add(e,t),this.timezone,this.localTimezone)}subtract(e,t){return this._fromDatetime(this.datetime.clone().subtract(e,t),this.timezone,this.localTimezone)}datetimeWithZone(e){return this.datetime.clone().tz(e)}format(e){return e?this.datetime.tz(this.localTimezone).format(e):this.datetime.tz(this.localTimezone).toISOString(!0)}_fromDatetime(e,t,o){return a.fromDatetime(e,t,o)}}e.default=a}),define("discourse/plugins/discourse-local-dates/lib/discourse-markdown/discourse-local-dates",["exports"],function(e){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.setup=function(e){e.allowList(["span.discourse-local-date","span[aria-label]","span[data-calendar]","span[data-countdown]","span[data-date]","span[data-displayed-timezone]","span[data-email-preview]","span[data-format]","span[data-ics]","span[data-recurring]","span[data-time]","span[data-timezone]","span[data-timezones]"]),e.registerOptions((e,t)=>{e.datesEmailFormat=t.discourse_local_dates_email_format,e.datesEmailTimezone=t.discourse_local_dates_email_timezone,e.features["discourse-local-dates"]=!!t.discourse_local_dates_enabled}),e.registerPlugin(e=>{e.core.textPostProcess.ruler.push("date",{matcher:/\[date=.+?\]/,onMatch:i}),e.core.textPostProcess.ruler.push("date-range",{matcher:/\[date-range .+?\]/,onMatch:n})})},moment.tz.link(["Asia/Kolkata|IST","Asia/Seoul|KST","Asia/Tokyo|JST"])
const t=moment.tz.names()
function a(e){return moment(e,"YYYY-M-D").format("YYYY-MM-DD")}function o(e,o,i,n){e.timezone&&(t.includes(e.timezone)||delete e.timezone),e.displayedTimezone&&(t.includes(e.displayedTimezone)||delete e.displayedTimezone),e.timezones&&(e.timezones=e.timezones.split("|").filter(e=>t.includes(e)).join("|")),e._default&&(e._default=a(e._default)),e.date&&(e.date=a(e.date))
const s=moment.tz([e._default||e.date,e.time].filter(Boolean).join("T"),e.timezone||"Etc/UTC"),r=o.md.options.discourse.datesEmailFormat||moment.defaultFormat,d=o.md.options.discourse.datesEmailTimezone||"Etc/UTC"
e.emailPreview=`${s.utc().tz(d).format(r)}`
let l=new o.Token("span_open","span",1)
l.attrs=[["class","discourse-local-date"]],n(l,e,"date"),i.push(l),l=new o.Token("text","",0),l.content=s.utc().format(e.format),i.push(l),l=new o.Token("span_close","span",-1),i.push(l)}function i(e,t,a,{parseBBCodeTag:i,applyDataAttributes:n}){const s=i(t[0],0,t[0].length)
if("date"===s?.tag)o(s.attrs,a,e,n)
else{let o=new a.Token("text","",0)
o.content=t[0],e.push(o)}}function n(e,t,a,{parseBBCodeTag:i,applyDataAttributes:n}){let s
const r=i(t[0],0,t[0].length)
if("date-range"===r?.tag){if(r.attrs.from){const{from:t,...i}={...r.attrs,range:"from"}
delete i.to,[i.date,i.time]=t.split("T"),o(i,a,e,n)}if(r.attrs.from&&r.attrs.to&&(s=new a.Token("text","",0),s.content="→",e.push(s)),r.attrs.to){const{to:t,...i}={...r.attrs,range:"to"}
delete i.from,[i.date,i.time]=t.split("T"),o(i,a,e,n)}}else s=new a.Token("text","",0),s.content=t[0],e.push(s)}}),define("discourse/plugins/discourse-local-dates/lib/format-local-date",["exports","discourse/plugins/discourse-local-dates/lib/local-date-builder"],function(e,t){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e,a,o,i={}){const n=moment.tz.guess(),s={...i,date:e,time:a,timezone:o||n,calendar:!i.format},r=new t.default(s,n),{formatted:d,pastEvent:l}=r.build()
return{formatted:d,pastEvent:l}}}),define("discourse/plugins/discourse-local-dates/lib/generate-current-date-markup",["exports","discourse/plugins/discourse-local-dates/lib/local-date-markup-generator"],function(e,t){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e){return(0,t.default)({date:moment().format("YYYY-MM-DD"),time:moment().format("HH:mm:ss")},{timezone:e||moment.tz.guess()},!1)}}),define("discourse/plugins/discourse-local-dates/lib/local-date-builder",["exports","discourse/lib/array-tools","discourse/lib/icon-library","discourse-i18n","discourse/plugins/discourse-local-dates/lib/date-with-zone-helper"],function(e,t,a,o,i){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
const n="h:mm A"
e.default=class{constructor(e={},t){this.time=e.time,this.date=e.date,this.recurring=e.recurring,this.sameLocalDayAsFrom=e.sameLocalDayAsFrom,this.timezones=Array.from(new Set((e.timezones||[]).filter(Boolean))),this.timezone=e.timezone||"UTC",this.calendar=void 0===e.calendar||e.calendar,this.displayedTimezone=e.displayedTimezone,this.format=e.format||(this.time?"LLL":"LL"),this.countdown=e.countdown,this.duration=e.duration,this.localTimezone=t}build(){const[e,t,a]=this.date.split("-").map(e=>parseInt(e,10)),[o,n,s]=(this.time||"").split(":").map(e=>e?parseInt(e,10):void 0)
let r
r=this.time?this.displayedTimezone||this.localTimezone:this.displayedTimezone||this.timezone||this.localTimezone
let d=new i.default({year:e,month:t?t-1:null,day:a,hour:o,minute:n,second:s,timezone:this.timezone,localTimezone:this.localTimezone})
if(this.recurring&&moment().isAfter(d.datetime)){const e=this.recurring.split(".")[1],t=d.unitRepetitionsBetweenDates(this.recurring,moment.tz(this.localTimezone))
d=d.add(t,e)}const l=this._generatePreviews(d,r),c=void 0!==o
return{pastEvent:!this.recurring&&moment.tz(this.localTimezone).isAfter(d.datetime),formatted:this._applyFormatting(d,r,c),previews:l,textPreview:this._generateTextPreviews(l)}}_generateTextPreviews(e){return e.map(e=>`${this._zoneWithoutPrefix(e.timezone)} ${e.formatted}`).join(", ")}_generatePreviews(e,a){const o=[],n=this.timezones.filter(e=>!this._isEqualZones(e,this.localTimezone))
return o.push({timezone:this._zoneWithoutPrefix(this.localTimezone),current:!0,formatted:this._createDateTimeRange(i.default.fromDatetime(e.datetime,e.timezone,this.localTimezone),this.time,this.duration)}),!this.timezone||a!==this.localTimezone||this.timezone===a||this._isEqualZones(a,this.timezone)||this.timezones.some(e=>this._isEqualZones(e,this.timezone))||n.unshift(this.timezone),n.forEach(t=>{this._isEqualZones(t,a)||(this._isEqualZones(t,this.localTimezone)&&(t=this.localTimezone),o.push({timezone:this._zoneWithoutPrefix(t),formatted:this._createDateTimeRange(i.default.fromDatetime(e.datetime,e.timezone,t),this.time,this.duration)}))}),(0,t.uniqueItemsFromArray)(o,"timezone")}_isEqualZones(e,t){return!!(!e&&!t||e&&t)&&(!(!e.includes(t)&&!t.includes(e))||moment.tz(e).utcOffset()===moment.tz(t).utcOffset())}_createDateTimeRange(e,t,a){const[o,i]=this._calculateDatesForRange(e,t,a)
let s=[o.format("dddd, LL"),this._optionalTimeIcon(o,i),o.format(n)]
return i&&(s=s.concat(["→",i.format(this._endDateFormat(o,i))])),s.filter(Boolean).join(" ")}_shortFormat(e,t){return t.datetime.diff(e.datetime,"days")<1}_optionalTimeIcon(e,t){if(!t||this._shortFormat(e,t))return`<br />${(0,a.renderIcon)("string","clock")}`}_endDateFormat(e,t){return this._shortFormat(e,t)?n:"LLLL"}_calculateDatesForRange(e,t,a){if(t&&!a)return[e]
const o=[e,a?e.add(a,"minutes"):e.add(24,"hours")]
return a<0?o.reverse():o}_applyFormatting(e,t,a){if(this.countdown){const t=moment.tz(this.localTimezone).diff(e.datetime)
return t<0?moment.duration(t).humanize():(0,o.i18n)("discourse_local_dates.relative_dates.countdown.passed")}const i=this._isEqualZones(t,this.localTimezone)
if(this.calendar){const o=moment.tz(this.localTimezone).isBetween(e.subtract(2,"day").datetime,e.add(1,"day").datetime.endOf("day"))
if(this.sameLocalDayAsFrom)return this._timeOnlyFormat(e,t)
if(o&&i){const t=e.datetimeWithZone(this.localTimezone)
return a&&0===t.hours()&&0===t.minutes()?t.format("dddd"):t.calendar(moment.tz(e.timezone),this._calendarFormats(this.time?this.time:null))}}return i?e.format(this.format):this._formatWithZone(e,t,this.format)}_calendarFormats(e){return{sameDay:this._translateCalendarKey(e,"today"),nextDay:this._translateCalendarKey(e,"tomorrow"),lastDay:this._translateCalendarKey(e,"yesterday"),sameElse:"L"}}_translateCalendarKey(e,t){const a=(0,o.i18n)(`discourse_local_dates.relative_dates.${t}`,{time:"LT"})
return e?a.split("LT").map(e=>`[${e}]`).join("LT"):`[${a.replace(" LT","")}]`}_formatTimezone(e){return e.replace("_"," ").replace("Etc/","").split("/")}_zoneWithoutPrefix(e){const[t,a]=this._formatTimezone(e)
return a||t}_formatWithZone(e,t,a){return`${e.datetimeWithZone(t).format(a)} (${this._zoneWithoutPrefix(t)})`}_timeOnlyFormat(e,t){return this._formatWithZone(e,t,"LT")}}}),define("discourse/plugins/discourse-local-dates/lib/local-date-markup-generator",["exports","@ember/utils","discourse/lib/text"],function(e,t,a){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e,o,i,n){const s={}
i||(s.time=e.time)
s.format=e.format,s.timezone=o.timezone,s.countdown=o.countdown,s.displayedTimezone=o.displayedTimezone,s.timezones=Array.isArray(o.timezones)?o.timezones.join("|"):o.timezones,i||(s.recurring=o.recurring)
const r=(0,a.buildBBCodeAttrs)(s),d=r?` ${r}`:""
if(i){return`[date-range from=${[e.date,e.time].filter(e=>!(0,t.isEmpty)(e)).join("T")} to=${[n.date,n.time].filter(e=>!(0,t.isEmpty)(e)).join("T")}${d}]`}return`[date=${e.date}${d}]`}}),define("discourse/plugins/discourse-local-dates/lib/rich-editor-extension",["exports","discourse/lib/text","discourse/plugins/discourse-local-dates/lib/format-local-date"],function(e,t,a){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
const o=["format","recurring","timezones","countdown","displayedTimezone"]
function i(e,t,a=o){for(const o of a)if(t[o]){e["displayedTimezone"===o?"data-displayed-timezone":`data-${o}`]=t[o]}}function n(e,t=!1){const a={format:e.format,countdown:e.countdown,displayedTimezone:e.displayedTimezone,timezones:e.timezones?.split("|")}
return t&&(a.recurring=e.recurring),a}const s={nodeSpec:{local_date:{attrs:{date:{},time:{default:null},timezone:{default:null},format:{default:null},recurring:{default:null},timezones:{default:null},countdown:{default:null},displayedTimezone:{default:null}},group:"inline",inline:!0,parseDOM:[{tag:"span.discourse-local-date[data-date]",getAttrs:e=>({date:e.dataset.date,time:e.dataset.time,timezone:e.dataset.timezone,format:e.dataset.format,recurring:e.dataset.recurring,timezones:e.dataset.timezones,countdown:e.dataset.countdown,displayedTimezone:e.dataset.displayedTimezone})}],toDOM:e=>{const t=n(e.attrs,!0),{formatted:o}=(0,a.default)(e.attrs.date,e.attrs.time,e.attrs.timezone,t),s={class:"discourse-local-date cooked-date","data-date":e.attrs.date,"data-time":e.attrs.time,"data-timezone":e.attrs.timezone}
return i(s,e.attrs),["span",s,o]}},local_date_range:{attrs:{fromDate:{},toDate:{default:null},fromTime:{default:null},toTime:{default:null},timezone:{default:null},format:{default:null},timezones:{default:null},countdown:{default:null},displayedTimezone:{default:null}},group:"inline",inline:!0,parseDOM:[{tag:"span.discourse-local-date-range",getAttrs:e=>{const t=e.querySelector('[data-range="from"]'),a=e.querySelector('[data-range="to"]')
return!!t&&{fromDate:t.dataset.date,toDate:a?.dataset.date,fromTime:t.dataset.time,toTime:a?.dataset.time,timezone:t.dataset.timezone,format:t.dataset.format,timezones:t.dataset.timezones,countdown:t.dataset.countdown,displayedTimezone:t.dataset.displayedTimezone}}}],toDOM:e=>{const t=n(e.attrs),{formatted:o}=(0,a.default)(e.attrs.fromDate,e.attrs.fromTime,e.attrs.timezone,t),{formatted:s}=(0,a.default)(e.attrs.toDate,e.attrs.toTime,e.attrs.timezone,t),r=["format","timezones","countdown","displayedTimezone"],d={class:"discourse-local-date cooked-date","data-range":"from","data-date":e.attrs.fromDate,"data-time":e.attrs.fromTime,"data-timezone":e.attrs.timezone},l={class:"discourse-local-date cooked-date","data-range":"to","data-date":e.attrs.toDate,"data-time":e.attrs.toTime,"data-timezone":e.attrs.timezone}
return i(d,e.attrs,r),i(l,e.attrs,r),["span",{class:"discourse-local-date-range"},["span",d,o]," → ",["span",l,s]]}}},parse:{span_open(e,t,a,o){if("discourse-local-date"===t.attrGet("class"))return"from"===t.attrGet("data-range")?(e.openNode(e.schema.nodes.local_date_range,{fromDate:t.attrGet("data-date"),fromTime:t.attrGet("data-time"),timezone:t.attrGet("data-timezone"),format:t.attrGet("data-format"),timezones:t.attrGet("data-timezones"),countdown:t.attrGet("data-countdown"),displayedTimezone:t.attrGet("data-displayed-timezone")}),e.__localDateRange=!0,a.splice(o+1,1),a.splice(o+2,1),a.splice(o+3,1),!0):"to"===t.attrGet("data-range")?(e.top().attrs.toDate=t.attrGet("data-date"),e.top().attrs.toTime=t.attrGet("data-time"),delete e.__localDateRange,!0):(e.openNode(e.schema.nodes.local_date,{date:t.attrGet("data-date"),time:t.attrGet("data-time"),timezone:t.attrGet("data-timezone"),format:t.attrGet("data-format"),recurring:t.attrGet("data-recurring"),timezones:t.attrGet("data-timezones"),countdown:t.attrGet("data-countdown"),displayedTimezone:t.attrGet("data-displayed-timezone")}),a.splice(o+1,1),!0)},span_close(e){if(["local_date","local_date_range"].includes(e.top().type.name))return e.__localDateRange||e.closeNode(),!0}},serializeNode:({utils:{isBoundary:e}})=>({local_date(a,o,i,n){a.flushClose(),e(a.out,a.out.length-1)||a.write(" ")
const{date:s,...r}=o.attrs,d=(0,t.buildBBCodeAttrs)(r)
a.write(`[date=${s}${d?` ${d}`:""}]`)
const l=i.childCount>n+1?i.child(n+1):null
l?.isText&&!e(l.text,0)&&a.write(" ")},local_date_range(a,o,i,n){a.flushClose(),e(a.out,a.out.length-1)||a.write(" ")
const{fromDate:s,toDate:r,fromTime:d,toTime:l,...c}=o.attrs,m=s+(d?`T${d}`:""),u=r+(l?`T${l}`:""),f=(0,t.buildBBCodeAttrs)(c)
a.write(`[date-range from=${m} to=${u}${f?` ${f}`:""}]`)
const p=i.childCount>n+1?i.child(n+1):null
p?.isText&&!e(p.text,0)&&a.write(" ")}})}
e.default=s})

//# sourceMappingURL=discourse-local-dates-596e5c85.map